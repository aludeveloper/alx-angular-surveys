angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate","ngCookies"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var s={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},s,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,s){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},s,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,s){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,s){var i=e.ctrl;i.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",currentPageIndex:"=?",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate","$cookies","$sce","$filter","$window",function(n,t,s,i,o,r){function a(){l.formData.pages.sort(function(e,n){return e.number-n.number})}var l=this,u=e;l.largeFileFlag=!1,l.invalidPhone=!1,l.currentPageNumber,l.hideSaveButton=localStorage.getItem("hideSaveButton"),void 0!=l.hideSaveButton&&""!=l.hideSaveButton||(l.hideSaveButton=!1),e.$on("fileRequiredFlag",function(e,n){l.largeFileFlag=n}),e.$on("hideSaveButton",function(e,n){l.hideSaveButton=n.hideSaveButton}),e.$on("invalidPhoneFlag",function(e,n){l.invalidPhone=n}),e.$on("changeAllData",function(e,t){n(function(){void 0,void 0,angular.forEach(t.requiredQuestionList,function(e,n){angular.forEach(l.currentPage.elements,function(n,t){n.question&&n.question.id==e&&(n.question.required=!0)})}),angular.forEach(t.unrequiredQuestionList,function(e,n){angular.forEach(l.currentPage.elements,function(n,t){if(n.question&&n.question.id==e){var s=n.question.type;angular.forEach(l.responseData,function(n,t){t&&t==e&&(t&&"checkbox"==s?n.selectedAnswers=[]:l.responseData[t]={})}),n.question.required=!1}})})},4e3)}),l.stageNo=localStorage.getItem("stageIndexNo"),l.singleElRow=[],l.$onInit=function(){void 0,void 0,l.condtionalParaFlag=!0,l.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},l.options=angular.extend({},l.defaultOptions,l.options),l.submitStatus="NOT_SUBMITTED",l.formSubmitted=!1,a(),l.pageIdToPage={},l.formData.pages.forEach(function(e){l.pageIdToPage[e.id]=e}),l.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},u.submitButton=l.buttons.submitForm.visible,u.formValid=l.form,l.resetPages(),l.api&&(l.api.reset=function(){for(var e in l.responseData)l.responseData.hasOwnProperty(e)&&delete l.responseData[e];l.buttons.submitForm.visible=!1,u.submitButton=l.buttons.submitForm.visible,u.formValid=l.form,l.buttons.prevPage.visible=!1,l.buttons.nextPage.visible=!1,l.currentPage=null,n(l.resetPages,0)})},l.sfKeyValue="",l.getParseParaHtml=function(e){var n=e.SFKey;if(n){var t,o=localStorage.getItem("auth_token"),r=__env.apiUrl,a=JSON.parse(s.get("userInfo")),u=a.applicationIdMap,d=localStorage.getItem("applicationName");return angular.forEach(u,function(e,n){d=n,t=e}),$.ajax({async:!1,headers:{"X-AUTH-TOKEN":o,"content-Type":"Application/Json"},url:r+"salesforce/paragraph/"+n+"/"+d+"/"+a.email,success:function(e){l.sfKeyValue=e}}),i.trustAsHtml(l.sfKeyValue)}return i.trustAsHtml(e.html)},l.getVideoUrl=function(){angular.forEach(l.formData.pages,function(e,n){angular.forEach(e.elements,function(e,n){"videolink"===e.type&&(l.videourl=i.trustAsHtml(e.videolink.html))})})},l.getSfFlagValue=function(){var e;angular.forEach(l.formData.pages,function(n,t){angular.forEach(n.elements,function(n,t){n.selecteditem&&n.selecteditem.sfkey&&"paragraphcondition"==n.type&&(e=n.selecteditem.sfkey.key)})});var n,t,i=localStorage.getItem("auth_token"),o=__env.apiUrl,r=JSON.parse(s.get("userInfo")),a=r.applicationIdMap,u=localStorage.getItem("applicationName");angular.forEach(a,function(e,n){u=n,t=e}),""!=e&&void 0!=e&&""!=u&&void 0!=u&&$.ajax({async:!1,headers:{"X-AUTH-TOKEN":i,"content-Type":"Application/Json"},url:o+"/salesforce/conditionalpara/"+e+"/"+u+"/"+r.email,success:function(e){void 0,n=e}}),l.sfFlag=n,"Pass"==l.sfFlag?l.condtionalParaFlag=!0:l.condtionalParaFlag=!1},l.submitForm=function(){if(!l.form.$valid){var e=angular.element("[name='"+l.form.$name+"']");return e.find(".ng-invalid:visible:first").focus(),e.find(".ng-invalid:visible:first").blur(),!1}l.formSubmitted=!0,l.submitStatus="IN_PROGRESS",l.setCurrentPage(null);var n=l.onSubmit();n&&n.then(function(){l.submitStatus="SUCCESS"})["catch"](function(){l.submitStatus="ERROR"})},l.setCurrentPage=function(n){l.currentPage=n;for(var t=0;t<l.formData.pages.length;t++)l.formData.pages[t].elements=o("orderBy")(l.formData.pages[t].elements,"rowNumber");return void 0,l.totalPageLength=l.formData.pages.length,n?(l.setDefaultNextPage(),void l.initResponsesForCurrentPage()):(l.buttons.submitForm.visible=!1,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.prevPage.visible=!1,void(l.buttons.nextPage.visible=!1))},l.setDefaultNextPage=function(){var n=l.formData.pages.indexOf(l.currentPage);if(l.currentPage.isFirst=0==n,l.currentPage.isLast=n==l.formData.pages.length-1,l.buttons.submitForm.visible=l.currentPage.isLast,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.prevPage.visible=!l.currentPage.isFirst,l.buttons.nextPage.visible=!l.currentPage.isLast,l.currentPage.isLast?l.nextPage=null:l.nextPage=l.formData.pages[n+1],l.currentPage.pageFlow){var t=!1;l.currentPage.pageFlow.formSubmit?(l.nextPage=null,t=!0):l.currentPage.pageFlow.page?(l.nextPage=l.pageIdToPage[l.currentPage.pageFlow.page.id],l.buttons.nextPage.visible=!0):l.currentPage.isLast&&(l.nextPage=null,t=!0),l.buttons.submitForm.visible=t,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.nextPage.visible=!t}l.currentPageNumber=n+1,l.currentPageIndex=n+1},l.initResponsesForCurrentPage=function(){l.currentPage.elements.forEach(function(e){var n=e.question;n&&!l.responseData[n.id]&&(l.responseData[n.id]={})});var e=[];angular.forEach(l.currentPage.elements,function(n,t){e.push(n.rowNumber)}),l.elementWidth=[];var n=e.sort();void 0;var t={};n.forEach(function(e){t[e]=(t[e]||0)+1}),void 0,angular.forEach(t,function(e,n){void 0,l.elementWidth.push(100/e)}),void 0},l.getWidth=function(e){for(var n=0;n<l.elementWidth.length;n++){if(r.innerWidth<=960)return{width:"100%"};if(n+1==e)return{width:l.elementWidth[n]+"%"}}},l.beginResponse=function(){l.formData.pages.length>0&&(l.setCurrentPage(l.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage}))},l.resetPages=function(){l.prevPages=[],l.currentPage=null,l.nextPage=null,l.formSubmitted=!1,l.options.autoStart&&l.beginResponse()},l.goToPrevPage=function(){window.scrollTo(0,0),l.onBack();var n=l.prevPages.pop();l.setCurrentPage(n),l.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage})},l.goToNextPage=function(){if(!l.form.$valid){var n=angular.element("[name='"+l.form.$name+"']");return void 0,n.find(".ng-invalid:visible:first").focus(),n.find(".ng-invalid:visible:first").blur(),!1}window.scrollTo(0,0),l.onSave(),l.prevPages.push(l.currentPage),l.updateNextPageBasedOnAllAnswers(),l.setCurrentPage(l.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage})},l.updateNextPageBasedOnAllAnswers=function(){l.currentPage.elements.forEach(function(e){l.updateNextPageBasedOnPageElementAnswers(e)}),l.buttons.submitForm.visible=!l.nextPage,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.nextPage.visible=!!l.nextPage},l.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&l.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?l.nextPage=null:e.pageFlow.page&&(l.nextPage=l.pageIdToPage[e.pageFlow.page.id]))})},l.onResponseChanged=function(e){l.setDefaultNextPage(),l.updateNextPageBasedOnAllAnswers()},l.print=function(e){return e&&l.templateData?t(e)(l.templateData):e},1===angular.version.major&&angular.version.minor<5&&l.$onInit()}],link:function(n,t,s){var i=n.ctrl;i.formStatus&&(i.formStatus.form=i.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<i.formData.pages.length){i.resetPages();for(var s=0;s<t.page;s++)i.prevPages.push(i.formData.pages[s]);var o=i.formData.pages[t.page];i.setCurrentPage(o),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o}),i.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).config(["$mdDateLocaleProvider",function(e){e.formatDate=function(e){return e?moment(e).format("DD/MM/YYYY"):""},e.parseDate=function(e){var n=moment(e,"DD/MM/YYYY",!0);return n.isValid()?n.toDate():new Date(NaN)}}]),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,n){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var s=this;void 0==n.linkedquestionList&&(n.linkedquestionList=[]),s.largeFileFlag=!1,s.fileSelectedEvent=!1,s.invalidPhone=!1,s.functionclick=function(){document.getElementById("inputFile").click()},this.$onInit=function(){s.id=t.next(),"radio"==s.question.type?(s.questionResponse.selectedAnswer&&(s.selectedAnswerId=s.questionResponse.selectedAnswer.id,angular.forEach(s.question.offeredAnswers,function(e,n){s.selectedAnswerId==e.id&&(s.questionResponse.selectedAnswer=angular.toJson(e))}),s.selectedAnswerChanged()),s.questionResponse.other&&(s.isOtherAnswer=!0)):"checkbox"==s.question.type?(s.questionResponse.selectedAnswers&&s.questionResponse.selectedAnswers.length?s.selectedAnswer=!0:s.questionResponse.selectedAnswers=[],s.questionResponse.other&&(s.isOtherAnswer=!0)):"grid"==s.question.type?s.question.grid.cellInputType||(s.question.grid.cellInputType="radio"):"division"==s.question.type?(s.computeDivisionSum=function(){s.divisionSum=0,s.question.divisionList.forEach(function(e){0==s.questionResponse[e.id]||s.questionResponse[e.id]?s.divisionSum+=s.questionResponse[e.id]:(s.questionResponse[e.id]=null,s.divisionSum+=0)})},s.computeDivisionSum()):"date"==s.question.type||"datetime"==s.question.type||"time"==s.question.type?s.questionResponse.answer&&(s.questionResponse.answer=new Date(s.questionResponse.answer)):"file"==s.question.type&&(s.questionResponse.fileName=s.questionResponse.fileName_1,s.questionResponse.answer=s.questionResponse.answer),s.isAnswerSelected=!1,s.initialized=!0},s.hideRadioLinkedQuestions=function(t){e(function(){n.linkedquestionList.includes(t.id)&&(document.getElementById(t.id).parentElement.parentElement.parentElement.style.display="none"),"radio"==t.type&&(angular.forEach(t.offeredAnswers,function(e,t){if(null!=e.linkedquestion&&void 0!=e.linkedquestion)for(var s=0;s<e.linkedquestion.length;s++)n.linkedquestionList.includes(e.linkedquestion[s])||n.linkedquestionList.push(e.linkedquestion[s])}),void 0)},300)},s.mappingTelephoneQuestion=function(t){e(function(){if("telephone"==t.type){var e=$("#phone"),i=$("#error-msg"),o=$("#valid-msg");void 0,e.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(n){var t=n&&n.country?n.country:"";e(t)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var r=function(){e.removeClass("error"),i.addClass("hide"),o.addClass("hide")};e.blur(function(){r(),$.trim(e.val())&&(e.intlTelInput("isValidNumber")?(s.invalidPhone=!1,n.$broadcast("invalidPhoneFlag",s.invalidPhone),o.removeClass("hide")):(s.invalidPhone=!0,n.$broadcast("invalidPhoneFlag",s.invalidPhone),e.addClass("error"),i.removeClass("hide")))}),e.on("keyup change",r)}},3e3)},s.initQuestionsView=function(e){s.hideRadioLinkedQuestions(e),s.mappingTelephoneQuestion(e)},e(function(){$("#phone").on("countrychange",function(e,n){void 0,s.questionResponse.countryCode=n.dialCode})},500),s.dateChanged=function(e){s.questionResponse.answer=moment(e).startOf("day").format("MM/DD/YYYY")},s.selectedAnswerChanged=function(){e(function(){if("string"==typeof s.questionResponse.selectedAnswer||s.questionResponse.selectedAnswer instanceof String?(s.selectedQuestionAns=s.questionResponse.selectedAnswer,s.selectedQuestionAns=JSON.parse(s.selectedQuestionAns),s.resSelectedAnsLinkedQues=s.selectedQuestionAns.linkedquestion):s.resSelectedAnsLinkedQues=s.questionResponse.selectedAnswer.linkedquestion,null!=s.resSelectedAnsLinkedQues&&void 0!=s.resSelectedAnsLinkedQues)if(void 0===s.selectedLinkQ){s.selectedLinkQ=s.resSelectedAnsLinkedQues,void 0,n.unrequiredQuestionList=[],angular.forEach(s.question.offeredAnswers,function(e,t){angular.forEach(e.linkedquestion,function(e,t){n.unrequiredQuestionList.push(e)})});for(var e=0;e<s.selectedLinkQ.length;e++)document.getElementById(s.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="block",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n!==s.selectedLinkQ[e]});n.$broadcast("changeAllData",{requiredQuestionList:s.selectedLinkQ,unrequiredQuestionList:n.unrequiredQuestionList})}else{for(var e=0;e<s.selectedLinkQ.length;e++)document.getElementById(s.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="none",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n==s.selectedLinkQ[e]});"string"==typeof s.questionResponse.selectedAnswer||s.questionResponse.selectedAnswer instanceof String?(s.selectedQuestionAns=s.questionResponse.selectedAnswer,s.selectedQuestionAns=JSON.parse(s.selectedQuestionAns),s.resSelectedAnsLinkedQues=s.selectedQuestionAns.linkedquestion):s.resSelectedAnsLinkedQues=s.questionResponse.selectedAnswer.linkedquestion,s.selectedLinkQ=s.resSelectedAnsLinkedQues,n.unrequiredQuestionList=[],angular.forEach(s.question.offeredAnswers,function(e,t){angular.forEach(e.linkedquestion,function(e,t){n.unrequiredQuestionList.push(e)})});for(var e=0;e<s.selectedLinkQ.length;e++)document.getElementById(s.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="block",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n!==s.selectedLinkQ[e]});n.$broadcast("changeAllData",{requiredQuestionList:s.selectedLinkQ,unrequiredQuestionList:n.unrequiredQuestionList})}},1e3),delete s.questionResponse.other,s.isOtherAnswer=!1,s.answerChanged()},s.otherAnswerRadioChanged=function(){s.isOtherAnswer&&(s.questionResponse.selectedAnswer=null),s.answerChanged()},s.otherAnswerCheckboxChanged=function(){s.isOtherAnswer||delete s.questionResponse.other,s.selectedAnswer=!(!s.questionResponse.selectedAnswers.length&&!s.isOtherAnswer)||null,s.answerChanged()},s.toggleSelectedAnswer=function(e){void 0!=s.questionResponse.selectedAnswers?(s.questionResponse.selectedAnswers.indexOf(e.id)===-1?s.questionResponse.selectedAnswers.push(e.id):s.questionResponse.selectedAnswers.splice(s.questionResponse.selectedAnswers.indexOf(e.id),1),s.selectedAnswer=!(!s.questionResponse.selectedAnswers.length&&!s.isOtherAnswer)||null):s.questionResponse={selectedAnswers:[]},s.answerChanged()},s.answerChanged=function(){s.onResponseChanged&&s.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,t,s,i){var o=e.ctrl;o.print=i.print,t.bind("change",function(t){var s;if(t.target.files&&t.target.files.length>0&&(s=t.target.files[0].size/1024),void 0,void 0==s);else if(s<=5120){o.largeFileFlag=!1,o.fileSelectedEvent=!0,n.$broadcast("fileRequiredFlag",o.largeFileFlag);var i=new FileReader;t.target.files[0];i.onload=function(n){e.$apply(function(){o.questionResponse.answer=n.target.result,o.questionResponse.fileName=t.target.files[0].name,o.questionResponse.fileName_1=t.target.files[0].name})},i.readAsDataURL(t.target.files[0])}else e.$apply(function(){o.largeFileFlag=!0}),n.$broadcast("fileRequiredFlag",o.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,s){var i=e.ctrl;i.print=s.print}}});