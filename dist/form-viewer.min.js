angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate","ngCookies"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var i={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},i,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,i){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},i,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,i){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,i){var s=e.ctrl;s.print=i.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",currentPageIndex:"=?",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate","$cookies","$sce","$filter","$window",function(n,t,i,s,o,r){function a(){u.formData.pages.sort(function(e,n){return e.number-n.number})}var u=this,l=e;u.largeFileFlag=!1,u.invalidPhone=!1,u.currentPageNumber,u.hideSaveButton=localStorage.getItem("hideSaveButton"),void 0!=u.hideSaveButton&&""!=u.hideSaveButton||(u.hideSaveButton=!1),e.$on("fileRequiredFlag",function(e,n){u.largeFileFlag=n}),e.$on("hideSaveButton",function(e,n){u.hideSaveButton=n.hideSaveButton}),e.$on("invalidPhoneFlag",function(e,n){u.invalidPhone=n}),e.$on("changeAllData",function(e,t){n(function(){void 0,void 0,angular.forEach(t.requiredQuestionList,function(e,n){angular.forEach(u.currentPage.elements,function(n,t){n.question&&n.question.id==e&&(n.question.required=!0)})}),angular.forEach(t.unrequiredQuestionList,function(e,n){angular.forEach(u.currentPage.elements,function(n,t){if(n.question&&n.question.id==e){var i=n.question.type;angular.forEach(u.responseData,function(n,t){t&&t==e&&(t&&"checkbox"==i?n.selectedAnswers=[]:u.responseData[t]={})}),n.question.required=!1}})})},1e3)}),u.stageNo=localStorage.getItem("stageIndexNo"),u.singleElRow=[],u.$onInit=function(){u.condtionalParaFlag=!0,u.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},u.options=angular.extend({},u.defaultOptions,u.options),u.submitStatus="NOT_SUBMITTED",u.formSubmitted=!1,a(),u.pageIdToPage={},u.formData.pages.forEach(function(e){u.pageIdToPage[e.id]=e}),u.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},l.submitButton=u.buttons.submitForm.visible,l.formValid=u.form,u.resetPages(),u.api&&(u.api.reset=function(){for(var e in u.responseData)u.responseData.hasOwnProperty(e)&&delete u.responseData[e];u.buttons.submitForm.visible=!1,l.submitButton=u.buttons.submitForm.visible,l.formValid=u.form,u.buttons.prevPage.visible=!1,u.buttons.nextPage.visible=!1,u.currentPage=null,n(u.resetPages,0)})},u.sfKeyValue="",u.getParseParaHtml=function(e){var n=e.SFKey;if(n){var t,o=localStorage.getItem("auth_token"),r=__env.apiUrl,a=JSON.parse(i.get("userInfo")),l=a.applicationIdMap,d=localStorage.getItem("applicationName");return angular.forEach(l,function(e,n){d=n,t=e}),$.ajax({async:!1,headers:{"X-AUTH-TOKEN":o,"content-Type":"Application/Json"},url:r+"salesforce/paragraph/"+n+"/"+d+"/"+a.email,success:function(e){u.sfKeyValue=e}}),s.trustAsHtml(u.sfKeyValue)}return s.trustAsHtml(e.html)},u.getVideoUrl=function(){angular.forEach(u.formData.pages,function(e,n){angular.forEach(e.elements,function(e,n){"videolink"===e.type&&(u.videourl=s.trustAsHtml(e.videolink.html))})})},u.getSfFlagValue=function(){var e;angular.forEach(u.formData.pages,function(n,t){angular.forEach(n.elements,function(n,t){n.selecteditem&&n.selecteditem.sfkey&&"paragraphcondition"==n.type&&(e=n.selecteditem.sfkey.key)})});var n,t,s=localStorage.getItem("auth_token"),o=__env.apiUrl,r=JSON.parse(i.get("userInfo")),a=r.applicationIdMap,l=localStorage.getItem("applicationName");angular.forEach(a,function(e,n){l=n,t=e}),""!=e&&void 0!=e&&""!=l&&void 0!=l&&$.ajax({async:!1,headers:{"X-AUTH-TOKEN":s,"content-Type":"Application/Json"},url:o+"/salesforce/conditionalpara/"+e+"/"+l+"/"+r.email,success:function(e){void 0,n=e}}),u.sfFlag=n,"Pass"==u.sfFlag?u.condtionalParaFlag=!0:u.condtionalParaFlag=!1},u.submitForm=function(){if(!u.form.$valid){var e=angular.element("[name='"+u.form.$name+"']");return e.find(".ng-invalid:visible:first").focus(),e.find(".ng-invalid:visible:first").blur(),!1}u.formSubmitted=!0,u.submitStatus="IN_PROGRESS",u.setCurrentPage(null);var n=u.onSubmit();n&&n.then(function(){u.submitStatus="SUCCESS"})["catch"](function(){u.submitStatus="ERROR"})},u.setCurrentPage=function(n){u.currentPage=n,void 0;for(var t=0;t<u.formData.pages.length;t++)u.formData.pages[t].elements=o("orderBy")(u.formData.pages[t].elements,"rowNumber");return void 0,u.totalPageLength=u.formData.pages.length,n?(u.setDefaultNextPage(),void u.initResponsesForCurrentPage()):(u.buttons.submitForm.visible=!1,e.submitButton=u.buttons.submitForm.visible,e.formValid=u.form,u.buttons.prevPage.visible=!1,void(u.buttons.nextPage.visible=!1))},u.setDefaultNextPage=function(){var n=u.formData.pages.indexOf(u.currentPage);if(u.currentPage.isFirst=0==n,u.currentPage.isLast=n==u.formData.pages.length-1,u.buttons.submitForm.visible=u.currentPage.isLast,e.submitButton=u.buttons.submitForm.visible,e.formValid=u.form,u.buttons.prevPage.visible=!u.currentPage.isFirst,u.buttons.nextPage.visible=!u.currentPage.isLast,u.currentPage.isLast?u.nextPage=null:u.nextPage=u.formData.pages[n+1],u.currentPage.pageFlow){var t=!1;u.currentPage.pageFlow.formSubmit?(u.nextPage=null,t=!0):u.currentPage.pageFlow.page?(u.nextPage=u.pageIdToPage[u.currentPage.pageFlow.page.id],u.buttons.nextPage.visible=!0):u.currentPage.isLast&&(u.nextPage=null,t=!0),u.buttons.submitForm.visible=t,e.submitButton=u.buttons.submitForm.visible,e.formValid=u.form,u.buttons.nextPage.visible=!t}u.currentPageNumber=n+1,u.currentPageIndex=n+1},u.initResponsesForCurrentPage=function(){u.currentPage.elements.forEach(function(e){var n=e.question;u.responseData&&n&&!u.responseData[n.id]&&(u.responseData[n.id]={})});var e=[];angular.forEach(u.currentPage.elements,function(n,t){e.push(n.rowNumber)}),u.elementWidth=[];var n=e.sort(),t={};n.forEach(function(e){t[e]=(t[e]||0)+1}),angular.forEach(t,function(e,n){u.elementWidth.push(100/e)})},u.getWidth=function(e){for(var n=0;n<u.elementWidth.length;n++){if(r.innerWidth<=960)return{width:"100%"};if(n+1==e)return{width:u.elementWidth[n]+"%"}}},u.beginResponse=function(){u.formData.pages.length>0&&(u.setCurrentPage(u.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:u.currentPage}))},u.resetPages=function(){u.prevPages=[],u.currentPage=null,u.nextPage=null,u.formSubmitted=!1,u.options.autoStart&&u.beginResponse()},u.goToPrevPage=function(){window.scrollTo(0,0),u.onBack();var n=u.prevPages.pop();u.setCurrentPage(n),u.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:u.currentPage})},u.goToNextPage=function(){if(!u.form.$valid){var n=angular.element("[name='"+u.form.$name+"']");return void 0,n.find(".ng-invalid:visible:first").focus(),n.find(".ng-invalid:visible:first").blur(),!1}window.scrollTo(0,0),u.onSave(),u.prevPages.push(u.currentPage),u.updateNextPageBasedOnAllAnswers(),u.setCurrentPage(u.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:u.currentPage})},u.updateNextPageBasedOnAllAnswers=function(){u.currentPage.elements.forEach(function(e){u.updateNextPageBasedOnPageElementAnswers(e)}),u.buttons.submitForm.visible=!u.nextPage,e.submitButton=u.buttons.submitForm.visible,e.formValid=u.form,u.buttons.nextPage.visible=!!u.nextPage},u.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&u.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?u.nextPage=null:e.pageFlow.page&&(u.nextPage=u.pageIdToPage[e.pageFlow.page.id]))})},u.onResponseChanged=function(e){u.setDefaultNextPage(),u.updateNextPageBasedOnAllAnswers()},u.print=function(e){return e&&u.templateData?t(e)(u.templateData):e},1===angular.version.major&&angular.version.minor<5&&u.$onInit()}],link:function(n,t,i){var s=n.ctrl;s.formStatus&&(s.formStatus.form=s.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<s.formData.pages.length){s.resetPages();for(var i=0;i<t.page;i++)s.prevPages.push(s.formData.pages[i]);var o=s.formData.pages[t.page];s.setCurrentPage(o),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o}),s.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).config(["$mdDateLocaleProvider",function(e){e.formatDate=function(e){return e?moment(e).format("DD/MM/YYYY"):""},e.parseDate=function(e){var n=moment(e,"DD/MM/YYYY",!0);return n.isValid()?n.toDate():new Date(NaN)}}]),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,n){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var i=this;void 0==n.linkedquestionList&&(n.linkedquestionList=[]),i.largeFileFlag=!1,i.fileSelectedEvent=!1,i.invalidPhone=!1,i.functionclick=function(){document.getElementById("inputFile").click()},this.$onInit=function(){i.id=t.next(),void 0!=i.questionResponse&&("radio"==i.question.type?(i.questionResponse.selectedAnswer&&(i.selectedAnswerId=i.questionResponse.selectedAnswer.id,angular.forEach(i.question.offeredAnswers,function(e,n){i.selectedAnswerId==e.id&&(i.questionResponse.selectedAnswer=angular.toJson(e))}),i.selectedAnswerChanged()),i.questionResponse.other&&(i.isOtherAnswer=!0)):"checkbox"==i.question.type?(i.questionResponse.selectedAnswers&&i.questionResponse.selectedAnswers.length?i.selectedAnswer=!0:i.questionResponse.selectedAnswers=[],i.questionResponse.other&&(i.isOtherAnswer=!0)):"grid"==i.question.type?i.question.grid.cellInputType||(i.question.grid.cellInputType="radio"):"division"==i.question.type?(i.computeDivisionSum=function(){i.divisionSum=0,i.question.divisionList.forEach(function(e){0==i.questionResponse[e.id]||i.questionResponse[e.id]?i.divisionSum+=i.questionResponse[e.id]:(i.questionResponse[e.id]=null,i.divisionSum+=0)})},i.computeDivisionSum()):"date"==i.question.type||"datetime"==i.question.type||"time"==i.question.type?i.questionResponse.answer&&(i.questionResponse.answer=new Date(i.questionResponse.answer)):"file"==i.question.type&&(i.questionResponse.fileName=i.questionResponse.fileName_1,i.questionResponse.answer=i.questionResponse.answer),i.isAnswerSelected=!1,i.initialized=!0)},i.hideRadioLinkedQuestions=function(t){e(function(){n.linkedquestionList.includes(t.id)&&(document.getElementById(t.id).parentElement.parentElement.parentElement.style.display="none"),"radio"==t.type&&(angular.forEach(t.offeredAnswers,function(e,t){if(null!=e.linkedquestion&&void 0!=e.linkedquestion)for(var i=0;i<e.linkedquestion.length;i++)n.linkedquestionList.includes(e.linkedquestion[i])||n.linkedquestionList.push(e.linkedquestion[i])}),void 0)},300)},i.mappingTelephoneQuestion=function(t){e(function(){if("telephone"==t.type){var e=$("#phone"),s=$("#error-msg"),o=$("#valid-msg");void 0,e.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(n){var t=n&&n.country?n.country:"";e(t)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var r=function(){e.removeClass("error"),s.addClass("hide"),o.addClass("hide")};e.blur(function(){r(),$.trim(e.val())&&(e.intlTelInput("isValidNumber")?(i.invalidPhone=!1,n.$broadcast("invalidPhoneFlag",i.invalidPhone),o.removeClass("hide")):(i.invalidPhone=!0,n.$broadcast("invalidPhoneFlag",i.invalidPhone),e.addClass("error"),s.removeClass("hide")))}),e.on("keyup change",r)}},3e3)},i.initQuestionsView=function(e){i.hideRadioLinkedQuestions(e),i.mappingTelephoneQuestion(e)},e(function(){$("#phone").on("countrychange",function(e,n){i.questionResponse&&(i.questionResponse.countryCode=n.dialCode)})},500),i.dateChanged=function(e){i.questionResponse.answer=moment(e).startOf("day").format("MM/DD/YYYY")},i.selectedAnswerChanged=function(){e(function(){if("string"==typeof i.questionResponse.selectedAnswer||i.questionResponse.selectedAnswer instanceof String?(i.selectedQuestionAns=i.questionResponse.selectedAnswer,i.selectedQuestionAns=JSON.parse(i.selectedQuestionAns),i.resSelectedAnsLinkedQues=i.selectedQuestionAns.linkedquestion):i.resSelectedAnsLinkedQues=i.questionResponse.selectedAnswer.linkedquestion,null==i.resSelectedAnsLinkedQues){if(i.selectedLinkQ)for(var e=0;e<i.selectedLinkQ.length;e++)document.getElementById(i.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="none";void 0==i.selectedLinkQ?n.$broadcast("changeAllData",{requiredQuestionList:[],unrequiredQuestionList:n.linkedquestionList}):n.$broadcast("changeAllData",{requiredQuestionList:emptyArray,unrequiredQuestionList:i.selectedLinkQ})}else if(null!=i.resSelectedAnsLinkedQues&&void 0!=i.resSelectedAnsLinkedQues)if(void 0===i.selectedLinkQ){i.selectedLinkQ=i.resSelectedAnsLinkedQues,n.unrequiredQuestionList=[],angular.forEach(i.question.offeredAnswers,function(e,t){angular.forEach(e.linkedquestion,function(e,t){n.unrequiredQuestionList.push(e)})});for(var e=0;e<i.selectedLinkQ.length;e++)document.getElementById(i.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="block",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n!==i.selectedLinkQ[e]});n.$broadcast("changeAllData",{requiredQuestionList:i.selectedLinkQ,unrequiredQuestionList:n.unrequiredQuestionList})}else{for(var e=0;e<i.selectedLinkQ.length;e++)document.getElementById(i.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="none",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n==i.selectedLinkQ[e]});"string"==typeof i.questionResponse.selectedAnswer||i.questionResponse.selectedAnswer instanceof String?(i.selectedQuestionAns=i.questionResponse.selectedAnswer,i.selectedQuestionAns=JSON.parse(i.selectedQuestionAns),i.resSelectedAnsLinkedQues=i.selectedQuestionAns.linkedquestion):i.resSelectedAnsLinkedQues=i.questionResponse.selectedAnswer.linkedquestion,i.selectedLinkQ=i.resSelectedAnsLinkedQues,n.unrequiredQuestionList=[],angular.forEach(i.question.offeredAnswers,function(e,t){angular.forEach(e.linkedquestion,function(e,t){n.unrequiredQuestionList.push(e)})});for(var e=0;e<i.selectedLinkQ.length;e++)document.getElementById(i.selectedLinkQ[e]).parentElement.parentElement.parentElement.style.display="block",n.unrequiredQuestionList=n.unrequiredQuestionList.filter(function(n){return n!==i.selectedLinkQ[e]});n.$broadcast("changeAllData",{requiredQuestionList:i.selectedLinkQ,unrequiredQuestionList:n.unrequiredQuestionList})}},1e3),delete i.questionResponse.other,i.isOtherAnswer=!1,i.answerChanged()},i.otherAnswerRadioChanged=function(){i.isOtherAnswer&&(i.questionResponse.selectedAnswer=null),i.answerChanged()},i.otherAnswerCheckboxChanged=function(){i.isOtherAnswer||delete i.questionResponse.other,i.selectedAnswer=!(!i.questionResponse.selectedAnswers.length&&!i.isOtherAnswer)||null,i.answerChanged()},i.toggleSelectedAnswer=function(e){void 0!=i.questionResponse.selectedAnswers?(i.questionResponse.selectedAnswers.indexOf(e.id)===-1?i.questionResponse.selectedAnswers.push(e.id):i.questionResponse.selectedAnswers.splice(i.questionResponse.selectedAnswers.indexOf(e.id),1),i.selectedAnswer=!(!i.questionResponse.selectedAnswers.length&&!i.isOtherAnswer)||null):i.questionResponse={selectedAnswers:[]},i.answerChanged()},i.answerChanged=function(){i.onResponseChanged&&i.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,t,i,s){var o=e.ctrl;o.print=s.print,t.bind("change",function(t){var i;if(t.target.files&&t.target.files.length>0&&(i=t.target.files[0].size/1024),void 0,void 0==i);else if(i<=5120){o.largeFileFlag=!1,o.fileSelectedEvent=!0,n.$broadcast("fileRequiredFlag",o.largeFileFlag);var s=new FileReader;t.target.files[0];s.onload=function(n){e.$apply(function(){o.questionResponse.answer=n.target.result,o.questionResponse.fileName=t.target.files[0].name,o.questionResponse.fileName_1=t.target.files[0].name})},s.readAsDataURL(t.target.files[0])}else e.$apply(function(){o.largeFileFlag=!0}),n.$broadcast("fileRequiredFlag",o.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,i){var s=e.ctrl;s.print=i.print}}});