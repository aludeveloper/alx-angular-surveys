angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate","ngCookies"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var o={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},o,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,o){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},o,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,o){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,o){var i=e.ctrl;i.print=o.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",currentPageIndex:"=?",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate","$cookies","$sce",function(n,t,o,i){function s(){a.formData.pages.sort(function(e,n){return e.number-n.number})}var a=this,r=e;a.largeFileFlag=!1,a.invalidPhone=!1,a.currentPageNumber,a.hideSaveButton=localStorage.getItem("hideSaveButton"),void 0!=a.hideSaveButton&&""!=a.hideSaveButton||(a.hideSaveButton=!1),e.$on("fileRequiredFlag",function(e,n){a.largeFileFlag=n}),e.$on("hideSaveButton",function(e,n){a.hideSaveButton=n.hideSaveButton}),e.$on("invalidPhoneFlag",function(e,n){a.invalidPhone=n}),e.$on("changeAllData",function(e,n){void 0,void 0,angular.forEach(n.requiredQuestionList,function(e,n){angular.forEach(a.currentPage.elements,function(n,t){n.question&&n.question.id==e&&(n.question.required=!0)})}),angular.forEach(n.unrequiredQuestionList,function(e,n){angular.forEach(a.currentPage.elements,function(n,t){if(n.question&&n.question.id==e){var o=n.question.type;angular.forEach(a.responseData,function(n,t){t&&t==e&&(t&&"checkbox"==o?n.selectedAnswers=[]:a.responseData[t]={})}),n.question.required=!1}})})}),a.stageNo=localStorage.getItem("stageIndexNo"),a.$onInit=function(){a.condtionalParaFlag=!0,a.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},a.options=angular.extend({},a.defaultOptions,a.options),a.submitStatus="NOT_SUBMITTED",a.formSubmitted=!1,s(),a.pageIdToPage={},a.formData.pages.forEach(function(e){a.pageIdToPage[e.id]=e}),a.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},r.submitButton=a.buttons.submitForm.visible,r.formValid=a.form,a.resetPages(),a.api&&(a.api.reset=function(){for(var e in a.responseData)a.responseData.hasOwnProperty(e)&&delete a.responseData[e];a.buttons.submitForm.visible=!1,r.submitButton=a.buttons.submitForm.visible,r.formValid=a.form,a.buttons.prevPage.visible=!1,a.buttons.nextPage.visible=!1,a.currentPage=null,n(a.resetPages,0)})},a.getParseParaHtml=function(e){return i.trustAsHtml(e)},a.getVideoUrl=function(){angular.forEach(a.formData.pages,function(e,n){angular.forEach(e.elements,function(e,n){"videolink"===e.type&&(a.videourl=i.trustAsHtml(e.videolink.html))})})},a.getSfFlagValue=function(){var e;angular.forEach(a.formData.pages,function(n,t){angular.forEach(n.elements,function(n,t){n.selecteditem&&n.selecteditem.sfkey&&"paragraphcondition"==n.type&&(e=n.selecteditem.sfkey.key)})});var n,t,i=localStorage.getItem("auth_token"),s="http://localhost:9000/",r=JSON.parse(o.get("userInfo")),l=r.applicationIdMap,u=localStorage.getItem("applicationName");angular.forEach(l,function(e,n){u=n,t=e}),""!=e&&void 0!=e&&""!=u&&void 0!=u&&$.ajax({async:!1,headers:{"X-AUTH-TOKEN":i,"content-Type":"Application/Json"},url:s+"/salesforce/conditionalpara/"+e+"/"+u+"/"+r.email,success:function(e){void 0,n=e}}),a.sfFlag=n,"Pass"==a.sfFlag?a.condtionalParaFlag=!0:a.condtionalParaFlag=!1},a.submitForm=function(){if(!a.form.$valid){var e=angular.element("[name='"+a.form.$name+"']");return e.find(".ng-invalid:visible:first").focus(),e.find(".ng-invalid:visible:first").blur(),!1}a.formSubmitted=!0,a.submitStatus="IN_PROGRESS",a.setCurrentPage(null);var n=a.onSubmit();n&&n.then(function(){a.submitStatus="SUCCESS"})["catch"](function(){a.submitStatus="ERROR"})},a.setCurrentPage=function(n){return a.currentPage=n,void 0,a.totalPageLength=a.formData.pages.length,n?(a.setDefaultNextPage(),void a.initResponsesForCurrentPage()):(a.buttons.submitForm.visible=!1,e.submitButton=a.buttons.submitForm.visible,e.formValid=a.form,a.buttons.prevPage.visible=!1,void(a.buttons.nextPage.visible=!1))},a.setDefaultNextPage=function(){var n=a.formData.pages.indexOf(a.currentPage);if(a.currentPage.isFirst=0==n,a.currentPage.isLast=n==a.formData.pages.length-1,a.buttons.submitForm.visible=a.currentPage.isLast,e.submitButton=a.buttons.submitForm.visible,e.formValid=a.form,a.buttons.prevPage.visible=!a.currentPage.isFirst,a.buttons.nextPage.visible=!a.currentPage.isLast,a.currentPage.isLast?a.nextPage=null:a.nextPage=a.formData.pages[n+1],a.currentPage.pageFlow){var t=!1;a.currentPage.pageFlow.formSubmit?(a.nextPage=null,t=!0):a.currentPage.pageFlow.page?(a.nextPage=a.pageIdToPage[a.currentPage.pageFlow.page.id],a.buttons.nextPage.visible=!0):a.currentPage.isLast&&(a.nextPage=null,t=!0),a.buttons.submitForm.visible=t,e.submitButton=a.buttons.submitForm.visible,e.formValid=a.form,a.buttons.nextPage.visible=!t}a.currentPageNumber=n+1,a.currentPageIndex=n+1},a.initResponsesForCurrentPage=function(){a.currentPage.elements.forEach(function(e){var n=e.question;n&&!a.responseData[n.id]&&(a.responseData[n.id]={})})},a.beginResponse=function(){a.formData.pages.length>0&&(a.setCurrentPage(a.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:a.currentPage}))},a.resetPages=function(){a.prevPages=[],a.currentPage=null,a.nextPage=null,a.formSubmitted=!1,a.options.autoStart&&a.beginResponse()},a.goToPrevPage=function(){window.scrollTo(0,0),a.onBack();var n=a.prevPages.pop();a.setCurrentPage(n),a.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:a.currentPage})},a.goToNextPage=function(){if(!a.form.$valid){var n=angular.element("[name='"+a.form.$name+"']");return void 0,n.find(".ng-invalid:visible:first").focus(),n.find(".ng-invalid:visible:first").blur(),!1}window.scrollTo(0,0),a.onSave(),a.prevPages.push(a.currentPage),a.updateNextPageBasedOnAllAnswers(),a.setCurrentPage(a.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:a.currentPage})},a.updateNextPageBasedOnAllAnswers=function(){a.currentPage.elements.forEach(function(e){a.updateNextPageBasedOnPageElementAnswers(e)}),a.buttons.submitForm.visible=!a.nextPage,e.submitButton=a.buttons.submitForm.visible,e.formValid=a.form,a.buttons.nextPage.visible=!!a.nextPage},a.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&a.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?a.nextPage=null:e.pageFlow.page&&(a.nextPage=a.pageIdToPage[e.pageFlow.page.id]))})},a.onResponseChanged=function(e){a.setDefaultNextPage(),a.updateNextPageBasedOnAllAnswers()},a.print=function(e){return e&&a.templateData?t(e)(a.templateData):e},1===angular.version.major&&angular.version.minor<5&&a.$onInit()}],link:function(n,t,o){var i=n.ctrl;i.formStatus&&(i.formStatus.form=i.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<i.formData.pages.length){i.resetPages();for(var o=0;o<t.page;o++)i.prevPages.push(i.formData.pages[o]);var s=i.formData.pages[t.page];i.setCurrentPage(s),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:s}),i.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).config(["$mdDateLocaleProvider",function(e){e.formatDate=function(e){return e?moment(e).format("DD/MM/YYYY"):""},e.parseDate=function(e){var n=moment(e,"DD/MM/YYYY",!0);return n.isValid()?n.toDate():new Date(NaN)}}]),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,n){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var o=this;void 0==n.linkedquestionList&&(n.linkedquestionList=[]),o.largeFileFlag=!1,o.fileSelectedEvent=!1,o.invalidPhone=!1,o.functionclick=function(){document.getElementById("inputFile").click()},this.$onInit=function(){o.id=t.next(),"radio"==o.question.type?o.questionResponse.other&&(o.isOtherAnswer=!0):"checkbox"==o.question.type?(o.questionResponse.selectedAnswers&&o.questionResponse.selectedAnswers.length?o.selectedAnswer=!0:o.questionResponse.selectedAnswers=[],o.questionResponse.other&&(o.isOtherAnswer=!0)):"grid"==o.question.type?o.question.grid.cellInputType||(o.question.grid.cellInputType="radio"):"division"==o.question.type?(o.computeDivisionSum=function(){o.divisionSum=0,o.question.divisionList.forEach(function(e){0==o.questionResponse[e.id]||o.questionResponse[e.id]?o.divisionSum+=o.questionResponse[e.id]:(o.questionResponse[e.id]=null,o.divisionSum+=0)})},o.computeDivisionSum()):"date"==o.question.type||"datetime"==o.question.type||"time"==o.question.type?o.questionResponse.answer&&(o.questionResponse.answer=new Date(o.questionResponse.answer)):"file"==o.question.type&&(o.questionResponse.fileName=o.questionResponse.fileName_1,o.questionResponse.answer=o.questionResponse.answer),o.isAnswerSelected=!1,o.initialized=!0},o.hideRadioLinkedQuestions=function(t){void 0,e(function(){n.linkedquestionList.includes(t.id)&&(document.getElementById(t.id).parentElement.parentElement.parentElement.style.display="none"),"radio"!=t.type&&"select"!=t.type||(angular.forEach(t.offeredAnswers,function(e,t){if(null!=e.linkedquestion&&void 0!=e.linkedquestion)for(var o=0;o<e.linkedquestion.length;o++)n.linkedquestionList.includes(e.linkedquestion[o])||n.linkedquestionList.push(e.linkedquestion[o])}),void 0)},300)},o.mappingTelephoneQuestion=function(t){e(function(){if("telephone"==t.type){var e=$("#phone"),i=$("#error-msg"),s=$("#valid-msg");void 0,e.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(n){var t=n&&n.country?n.country:"";e(t)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var a=function(){e.removeClass("error"),i.addClass("hide"),s.addClass("hide")};e.blur(function(){a(),$.trim(e.val())&&(e.intlTelInput("isValidNumber")?(o.invalidPhone=!1,n.$broadcast("invalidPhoneFlag",o.invalidPhone),s.removeClass("hide")):(o.invalidPhone=!0,n.$broadcast("invalidPhoneFlag",o.invalidPhone),e.addClass("error"),i.removeClass("hide")))}),e.on("keyup change",a)}},3e3)},o.initQuestionsView=function(e){void 0,o.mappingTelephoneQuestion(e)},e(function(){$("#phone").on("countrychange",function(e,n){void 0,o.questionResponse.countryCode=n.dialCode})},500),o.dateChanged=function(e){o.questionResponse.answer=moment(e).startOf("day").format("MM/DD/YYYY")},o.selectedAnswerChanged=function(){void 0,delete o.questionResponse.other,o.isOtherAnswer=!1,o.answerChanged()},o.otherAnswerRadioChanged=function(){o.isOtherAnswer&&(o.questionResponse.selectedAnswer=null),o.answerChanged()},o.otherAnswerCheckboxChanged=function(){o.isOtherAnswer||delete o.questionResponse.other,o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null,o.answerChanged()},o.toggleSelectedAnswer=function(e){void 0!=o.questionResponse.selectedAnswers?(o.questionResponse.selectedAnswers.indexOf(e.id)===-1?o.questionResponse.selectedAnswers.push(e.id):o.questionResponse.selectedAnswers.splice(o.questionResponse.selectedAnswers.indexOf(e.id),1),o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null):o.questionResponse={selectedAnswers:[]},o.answerChanged()},o.answerChanged=function(){o.onResponseChanged&&o.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,t,o,i){var s=e.ctrl;s.print=i.print,t.bind("change",function(t){var o;if(null!=t.target.files&&(o=t.target.files[0].size/1024),void 0,void 0==o);else if(o<=1024){s.largeFileFlag=!1,s.fileSelectedEvent=!0,n.$broadcast("fileRequiredFlag",s.largeFileFlag);var i=new FileReader;t.target.files[0];i.onload=function(n){e.$apply(function(){s.questionResponse.answer=n.target.result,s.questionResponse.fileName=t.target.files[0].name,s.questionResponse.fileName_1=t.target.files[0].name})},i.readAsDataURL(t.target.files[0])}else e.$apply(function(){s.largeFileFlag=!0}),n.$broadcast("fileRequiredFlag",s.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,o){var i=e.ctrl;i.print=o.print}}});