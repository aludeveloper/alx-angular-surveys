angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate","ngCookies"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var o={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},o,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,o){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},o,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,o){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,o){var i=e.ctrl;i.print=o.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",currentPageIndex:"=?",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",onSave:"&",onBack:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate","$cookies","$sce","$filter","$window",function(n,t,o,i,a,r){function s(){l.formData.pages.sort(function(e,n){return e.number-n.number})}var l=this,u=e;l.largeFileFlag=!1,l.invalidPhone=!1,l.currentPageNumber,l.hideSaveButton=localStorage.getItem("hideSaveButton"),void 0!=l.hideSaveButton&&""!=l.hideSaveButton||(l.hideSaveButton=!1),e.$on("fileRequiredFlag",function(e,n){l.largeFileFlag=n}),e.$on("hideSaveButton",function(e,n){l.hideSaveButton=n.hideSaveButton}),e.$on("invalidPhoneFlag",function(e,n){l.invalidPhone=n}),e.$on("changeAllData",function(e,n){void 0,void 0,angular.forEach(n.requiredQuestionList,function(e,n){angular.forEach(l.currentPage.elements,function(n,t){n.question&&n.question.id==e&&(n.question.required=!0)})}),angular.forEach(n.unrequiredQuestionList,function(e,n){angular.forEach(l.currentPage.elements,function(n,t){if(n.question&&n.question.id==e){var o=n.question.type;angular.forEach(l.responseData,function(n,t){t&&t==e&&(t&&"checkbox"==o?n.selectedAnswers=[]:l.responseData[t]={})}),n.question.required=!1}})})}),l.stageNo=localStorage.getItem("stageIndexNo"),l.singleElRow=[],l.$onInit=function(){l.condtionalParaFlag=!0,l.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},l.options=angular.extend({},l.defaultOptions,l.options),l.submitStatus="NOT_SUBMITTED",l.formSubmitted=!1,s(),l.pageIdToPage={},l.formData.pages.forEach(function(e){l.pageIdToPage[e.id]=e}),l.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},u.submitButton=l.buttons.submitForm.visible,u.formValid=l.form,l.resetPages(),l.api&&(l.api.reset=function(){for(var e in l.responseData)l.responseData.hasOwnProperty(e)&&delete l.responseData[e];l.buttons.submitForm.visible=!1,u.submitButton=l.buttons.submitForm.visible,u.formValid=l.form,l.buttons.prevPage.visible=!1,l.buttons.nextPage.visible=!1,l.currentPage=null,n(l.resetPages,0)})},l.sfKeyValue="",l.getParseParaHtml=function(e){var n=e.SFKey;if(n){var t,a=localStorage.getItem("auth_token"),r=__env.apiUrl,s=JSON.parse(o.get("userInfo")),u=s.applicationIdMap,c=localStorage.getItem("applicationName");return angular.forEach(u,function(e,n){c=n,t=e}),$.ajax({async:!1,headers:{"X-AUTH-TOKEN":a,"content-Type":"Application/Json"},url:r+"salesforce/paragraph/"+n+"/"+c+"/"+s.email,success:function(e){l.sfKeyValue=e}}),i.trustAsHtml(l.sfKeyValue)}return i.trustAsHtml(e.html)},l.getVideoUrl=function(){angular.forEach(l.formData.pages,function(e,n){angular.forEach(e.elements,function(e,n){"videolink"===e.type&&(l.videourl=i.trustAsHtml(e.videolink.html))})})},l.getSfFlagValue=function(){var e;angular.forEach(l.formData.pages,function(n,t){angular.forEach(n.elements,function(n,t){n.selecteditem&&n.selecteditem.sfkey&&"paragraphcondition"==n.type&&(e=n.selecteditem.sfkey.key)})});var n,t,i=localStorage.getItem("auth_token"),a=__env.apiUrl,r=JSON.parse(o.get("userInfo")),s=r.applicationIdMap,u=localStorage.getItem("applicationName");angular.forEach(s,function(e,n){u=n,t=e}),""!=e&&void 0!=e&&""!=u&&void 0!=u&&$.ajax({async:!1,headers:{"X-AUTH-TOKEN":i,"content-Type":"Application/Json"},url:a+"/salesforce/conditionalpara/"+e+"/"+u+"/"+r.email,success:function(e){void 0,n=e}}),l.sfFlag=n,"Pass"==l.sfFlag?l.condtionalParaFlag=!0:l.condtionalParaFlag=!1},l.submitForm=function(){if(!l.form.$valid){var e=angular.element("[name='"+l.form.$name+"']");return e.find(".ng-invalid:visible:first").focus(),e.find(".ng-invalid:visible:first").blur(),!1}l.formSubmitted=!0,l.submitStatus="IN_PROGRESS",l.setCurrentPage(null);var n=l.onSubmit();n&&n.then(function(){l.submitStatus="SUCCESS"})["catch"](function(){l.submitStatus="ERROR"})},l.setCurrentPage=function(n){l.currentPage=n,void 0;for(var t=0;t<l.formData.pages.length;t++)l.formData.pages[t].elements=a("orderBy")(l.formData.pages[t].elements,"rowNumber");return void 0,l.totalPageLength=l.formData.pages.length,n?(l.setDefaultNextPage(),void l.initResponsesForCurrentPage()):(l.buttons.submitForm.visible=!1,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.prevPage.visible=!1,void(l.buttons.nextPage.visible=!1))},l.setDefaultNextPage=function(){var n=l.formData.pages.indexOf(l.currentPage);if(l.currentPage.isFirst=0==n,l.currentPage.isLast=n==l.formData.pages.length-1,l.buttons.submitForm.visible=l.currentPage.isLast,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.prevPage.visible=!l.currentPage.isFirst,l.buttons.nextPage.visible=!l.currentPage.isLast,l.currentPage.isLast?l.nextPage=null:l.nextPage=l.formData.pages[n+1],l.currentPage.pageFlow){var t=!1;l.currentPage.pageFlow.formSubmit?(l.nextPage=null,t=!0):l.currentPage.pageFlow.page?(l.nextPage=l.pageIdToPage[l.currentPage.pageFlow.page.id],l.buttons.nextPage.visible=!0):l.currentPage.isLast&&(l.nextPage=null,t=!0),l.buttons.submitForm.visible=t,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.nextPage.visible=!t}l.currentPageNumber=n+1,l.currentPageIndex=n+1},l.initResponsesForCurrentPage=function(){l.currentPage.elements.forEach(function(e){var n=e.question;n&&!l.responseData[n.id]&&(l.responseData[n.id]={})});var e=[];angular.forEach(l.currentPage.elements,function(n,t){e.push(n.rowNumber)}),l.elementWidth=[];var n=e.sort();void 0;var t={};n.forEach(function(e){t[e]=(t[e]||0)+1}),void 0,angular.forEach(t,function(e,n){void 0,l.elementWidth.push(100/e)}),void 0},l.getWidth=function(e){for(var n=0;n<l.elementWidth.length;n++){if(r.innerWidth<=960)return{width:"100%"};if(n+1==e)return{width:l.elementWidth[n]+"%"}}},l.beginResponse=function(){l.formData.pages.length>0&&(l.setCurrentPage(l.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage}))},l.resetPages=function(){l.prevPages=[],l.currentPage=null,l.nextPage=null,l.formSubmitted=!1,l.options.autoStart&&l.beginResponse()},l.goToPrevPage=function(){window.scrollTo(0,0),l.onBack();var n=l.prevPages.pop();l.setCurrentPage(n),l.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage})},l.goToNextPage=function(){if(!l.form.$valid){var n=angular.element("[name='"+l.form.$name+"']");return void 0,n.find(".ng-invalid:visible:first").focus(),n.find(".ng-invalid:visible:first").blur(),!1}window.scrollTo(0,0),l.onSave(),l.prevPages.push(l.currentPage),l.updateNextPageBasedOnAllAnswers(),l.setCurrentPage(l.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:l.currentPage})},l.updateNextPageBasedOnAllAnswers=function(){l.currentPage.elements.forEach(function(e){l.updateNextPageBasedOnPageElementAnswers(e)}),l.buttons.submitForm.visible=!l.nextPage,e.submitButton=l.buttons.submitForm.visible,e.formValid=l.form,l.buttons.nextPage.visible=!!l.nextPage},l.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&l.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?l.nextPage=null:e.pageFlow.page&&(l.nextPage=l.pageIdToPage[e.pageFlow.page.id]))})},l.onResponseChanged=function(e){l.setDefaultNextPage(),l.updateNextPageBasedOnAllAnswers()},l.print=function(e){return e&&l.templateData?t(e)(l.templateData):e},1===angular.version.major&&angular.version.minor<5&&l.$onInit()}],link:function(n,t,o){var i=n.ctrl;i.formStatus&&(i.formStatus.form=i.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<i.formData.pages.length){i.resetPages();for(var o=0;o<t.page;o++)i.prevPages.push(i.formData.pages[o]);var a=i.formData.pages[t.page];i.setCurrentPage(a),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:a}),i.updateNextPageBasedOnAllAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).config(["$mdDateLocaleProvider",function(e){e.formatDate=function(e){return e?moment(e).format("DD/MM/YYYY"):""},e.parseDate=function(e){var n=moment(e,"DD/MM/YYYY",!0);return n.isValid()?n.toDate():new Date(NaN)}}]),angular.module("mwFormViewer").directive("mwFormQuestion",["$parse","$rootScope",function(e,n){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,t){var o=this;void 0==n.linkedquestionList&&(n.linkedquestionList=[]),o.largeFileFlag=!1,o.fileSelectedEvent=!1,o.invalidPhone=!1,o.functionclick=function(){document.getElementById("inputFile").click()},this.$onInit=function(){o.id=t.next(),"radio"==o.question.type?o.questionResponse.other&&(o.isOtherAnswer=!0):"checkbox"==o.question.type?(o.questionResponse.selectedAnswers&&o.questionResponse.selectedAnswers.length?o.selectedAnswer=!0:o.questionResponse.selectedAnswers=[],o.questionResponse.other&&(o.isOtherAnswer=!0)):"grid"==o.question.type?o.question.grid.cellInputType||(o.question.grid.cellInputType="radio"):"division"==o.question.type?(o.computeDivisionSum=function(){o.divisionSum=0,o.question.divisionList.forEach(function(e){0==o.questionResponse[e.id]||o.questionResponse[e.id]?o.divisionSum+=o.questionResponse[e.id]:(o.questionResponse[e.id]=null,o.divisionSum+=0)})},o.computeDivisionSum()):"date"==o.question.type||"datetime"==o.question.type||"time"==o.question.type?o.questionResponse.answer&&(o.questionResponse.answer=new Date(o.questionResponse.answer)):"file"==o.question.type&&(o.questionResponse.fileName=o.questionResponse.fileName_1,o.questionResponse.answer=o.questionResponse.answer),o.isAnswerSelected=!1,o.initialized=!0},o.hideRadioLinkedQuestions=function(t){void 0,e(function(){n.linkedquestionList.includes(t.id)&&(document.getElementById(t.id).parentElement.parentElement.parentElement.style.display="none"),"radio"!=t.type&&"select"!=t.type||(angular.forEach(t.offeredAnswers,function(e,t){if(null!=e.linkedquestion&&void 0!=e.linkedquestion)for(var o=0;o<e.linkedquestion.length;o++)n.linkedquestionList.includes(e.linkedquestion[o])||n.linkedquestionList.push(e.linkedquestion[o])}),void 0)},300)},o.mappingTelephoneQuestion=function(t){e(function(){if("telephone"==t.type){var e=$("#phone"),i=$("#error-msg"),a=$("#valid-msg");void 0,e.intlTelInput({initialCountry:"auto",geoIpLookup:function(e){$.get("https://ipinfo.io",function(){},"jsonp").always(function(n){var t=n&&n.country?n.country:"";e(t)})},utilsScript:"../bower_components/intl-tel-input/build/js/utils.js"});var r=function(){e.removeClass("error"),i.addClass("hide"),a.addClass("hide")};e.blur(function(){r(),$.trim(e.val())&&(e.intlTelInput("isValidNumber")?(o.invalidPhone=!1,n.$broadcast("invalidPhoneFlag",o.invalidPhone),a.removeClass("hide")):(o.invalidPhone=!0,n.$broadcast("invalidPhoneFlag",o.invalidPhone),e.addClass("error"),i.removeClass("hide")))}),e.on("keyup change",r)}},3e3)},o.initQuestionsView=function(e){void 0,o.mappingTelephoneQuestion(e)},e(function(){$("#phone").on("countrychange",function(e,n){void 0,o.questionResponse.countryCode=n.dialCode})},500),o.dateChanged=function(e){o.questionResponse.answer=moment(e).startOf("day").format("MM/DD/YYYY")},o.selectedAnswerChanged=function(){void 0,delete o.questionResponse.other,o.isOtherAnswer=!1,o.answerChanged()},o.otherAnswerRadioChanged=function(){o.isOtherAnswer&&(o.questionResponse.selectedAnswer=null),o.answerChanged()},o.otherAnswerCheckboxChanged=function(){o.isOtherAnswer||delete o.questionResponse.other,o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null,o.answerChanged()},o.toggleSelectedAnswer=function(e){void 0!=o.questionResponse.selectedAnswers?(o.questionResponse.selectedAnswers.indexOf(e.id)===-1?o.questionResponse.selectedAnswers.push(e.id):o.questionResponse.selectedAnswers.splice(o.questionResponse.selectedAnswers.indexOf(e.id),1),o.selectedAnswer=!(!o.questionResponse.selectedAnswers.length&&!o.isOtherAnswer)||null):o.questionResponse={selectedAnswers:[]},o.answerChanged()},o.answerChanged=function(){o.onResponseChanged&&o.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,t,o,i){var a=e.ctrl;a.print=i.print,t.bind("change",function(t){var o;if(t.target.files&&t.target.files.length>0&&(o=t.target.files[0].size/1024),void 0,void 0==o);else if(o<=5120){a.largeFileFlag=!1,a.fileSelectedEvent=!0,n.$broadcast("fileRequiredFlag",a.largeFileFlag);var i=new FileReader;t.target.files[0];i.onload=function(n){e.$apply(function(){a.questionResponse.answer=n.target.result,a.questionResponse.fileName=t.target.files[0].name,a.questionResponse.fileName_1=t.target.files[0].name})},i.readAsDataURL(t.target.files[0])}else e.$apply(function(){a.largeFileFlag=!0}),n.$broadcast("fileRequiredFlag",a.largeFileFlag),void 0})}}}]),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,o){var i=e.ctrl;i.print=o.print}}});